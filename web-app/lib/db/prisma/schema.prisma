datasource db {
  provider = "postgresql"
}

generator client {
  provider   = "prisma-client-js"
  output     = "../prisma/generated"
  engineType = "client"
}

model User {
  id            String  @id @default(cuid())
  walletAddress String  @unique
  name          String?
  email         String? @unique

  campaignsCreated Campaign[]      @relation("UserCampaigns")
  participations   Participation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Campaign {
  id String @id @default(cuid())

  ownerId String
  owner   User   @relation("UserCampaigns", fields: [ownerId], references: [id])

  title         String
  escrowAddress String
  budgetTotal   Decimal

  rewardEvents RewardEvent[]

  yellowChannelId String?
  status          CampaignStatus  @default(ACTIVE)
  participations  Participation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RewardEvent {
  id         String   @id @default(cuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])

  eventType  EventType
  amount     Decimal
  volumeStep Int       @default(1)

  selectors Selector[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Selector {
  id            String      @id @default(cuid())
  rewardEventId String
  rewardEvent   RewardEvent @relation(fields: [rewardEventId], references: [id])

  selector  String
  eventType SelectorEventType
  isActive  Boolean           @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([rewardEventId, selector])
}

model Participation {
  id           String   @id @default(cuid())
  influencerId String
  influencer   User     @relation(fields: [influencerId], references: [id])
  campaignId   String
  campaign     Campaign @relation(fields: [campaignId], references: [id])

  links          TrackingLink[]
  currentBalance Decimal        @default(0)

  events AnalyticsEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([influencerId, campaignId])
}

model TrackingLink {
  id              String        @id @default(cuid())
  url             String        @unique
  participationId String
  participation   Participation @relation(fields: [participationId], references: [id])

  isActive  Boolean   @default(true)
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AnalyticsEvent {
  id   String    @id @default(cuid())
  type EventType

  participationId String
  participation   Participation @relation(fields: [participationId], references: [id])

  externalTxId    String? @unique
  metadata        Json?
  payoutGenerated Decimal @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum EventType {
  VISIT_PAGE
  ADD_CART
  BUY_PRODUCT
  SIGNUP
}

enum SelectorEventType {
  ONCLICK
  HOVER
  DOUBLE_CLICK
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  DEPLETED
  DELETED
}
