datasource db {
  provider = "postgresql"
}

generator client {
  provider   = "prisma-client-js"
  output     = "../prisma/generated"
  engineType = "client"
}

model User {
  id                     String                       @id @default(cuid())
  walletAddress          String                       @unique
  name                   String?
  email                  String?                      @unique
  phone                  String?
  location               String?
  bio                    String?
  avatar                 String?
  interests              String[]                     @default([])
  affinities             String[]                     @default([])
  influencerVerification InfluencerVerificationStatus @default(NONE)

  socialMedias     SocialMedia[]
  campaignsCreated Campaign[]      @relation("UserCampaigns")
  sites            Site[]          @relation("UserSites")
  participations   Participation[]

  chatRoomsAsOne ChatRoom[]    @relation("ChatRoomUserOne")
  chatRoomsAsTwo ChatRoom[]    @relation("ChatRoomUserTwo")
  chatMessages   ChatMessage[] @relation("ChatMessageSender")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SocialMedia {
  id        String              @id @default(cuid())
  userId    String
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform  SocialMediaPlatform
  username  String
  followers Int?
  url       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, platform, username])
}

model Campaign {
  id String @id @default(cuid())

  ownerId String
  owner   User   @relation("UserCampaigns", fields: [ownerId], references: [id])

  title         String
  description   String?
  escrowAddress String
  budgetTotal   Decimal

  isHot        Boolean   @default(false)
  slots        Int       @default(10)
  interests    String[]  @default([])
  demographics String[]  @default([])
  regions      String[]  @default([])
  countries    String[]  @default([])
  startDate    DateTime?
  endDate      DateTime?

  siteEvents CampaignSiteEvent[]

  yellowChannelId String?
  ensSubdomain    String?         @unique
  status          CampaignStatus  @default(DRAFT)
  participations  Participation[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model Site {
  id      String @id @default(cuid())
  ownerId String
  owner   User   @relation("UserSites", fields: [ownerId], references: [id])

  name        String
  url         String
  description String

  siteEvents SiteEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ownerId, url])
}

model SiteEvent {
  id String @id @default(cuid())

  siteId String
  site   Site   @relation(fields: [siteId], references: [id])

  name      String
  eventType SiteEventType

  selectors         SiteEventSelector[]
  campaigns         CampaignSiteEvent[]
  trackedSiteEvents TrackedSiteEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
}

model CampaignSiteEvent {
  id String @id @default(cuid())

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])

  siteEventId String
  siteEvent   SiteEvent @relation(fields: [siteEventId], references: [id])

  amount     Decimal
  volumeStep Int     @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([campaignId, siteEventId])
}

model Client {
  id        String  @id @default(cuid())
  sessionId String  @unique
  userAgent String?
  ipAddress String?

  trackedSiteEvents TrackedSiteEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TrackedSiteEvent {
  id String @id @default(cuid())

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  siteEventId String
  siteEvent   SiteEvent @relation(fields: [siteEventId], references: [id])

  participationId String
  participation   Participation @relation(fields: [participationId], references: [id])

  data      Json?
  timestamp DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([siteEventId])
  @@index([participationId])
  @@index([timestamp])
}

model SiteEventSelector {
  id          String    @id @default(cuid())
  siteEventId String
  siteEvent   SiteEvent @relation(fields: [siteEventId], references: [id])

  selector  String
  eventType SelectorEventType
  isActive  Boolean           @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([siteEventId, selector])
}

model Participation {
  id           String   @id @default(cuid())
  influencerId String
  influencer   User     @relation(fields: [influencerId], references: [id])
  campaignId   String
  campaign     Campaign @relation(fields: [campaignId], references: [id])

  status         ParticipationStatus
  links          TrackingLink[]
  currentBalance Decimal             @default(0)

  rewards           Reward[]
  trackedSiteEvents TrackedSiteEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([influencerId, campaignId])
}

model TrackingLink {
  id              String        @id @default(cuid())
  url             String        @unique
  participationId String
  participation   Participation @relation(fields: [participationId], references: [id])

  isActive  Boolean   @default(true)
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Reward {
  id   String        @id @default(cuid())
  type SiteEventType

  participationId String
  participation   Participation @relation(fields: [participationId], references: [id])

  externalTxId    String? @unique
  metadata        Json?
  payoutGenerated Decimal @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ChatRoom {
  id String @id @default(cuid())

  userOneId String
  userOne   User   @relation("ChatRoomUserOne", fields: [userOneId], references: [id])

  userTwoId String
  userTwo   User   @relation("ChatRoomUserTwo", fields: [userTwoId], references: [id])

  lastActivityAt DateTime @default(now())

  messages ChatMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userOneId, userTwoId])
  @@index([lastActivityAt])
}

model ChatMessage {
  id String @id @default(cuid())

  chatRoomId String
  chatRoom   ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)

  senderId String
  sender   User   @relation("ChatMessageSender", fields: [senderId], references: [id])

  text       String
  ablySerial String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chatRoomId, createdAt])
  @@index([senderId])
}

enum SiteEventType {
  LANDING_PAGE_VIEW
  VIEW_ITEM
  ADD_TO_CART
  CHECKOUT
  PURCHASE_SUCCESS
}

enum SelectorEventType {
  ONCLICK
  HOVER
  DOUBLE_CLICK
  VISIT
}

enum SocialMediaPlatform {
  INSTAGRAM
  TIKTOK
  YOUTUBE
  TWITTER
  OTHER
}

enum CampaignStatus {
  DRAFT
  PUBLISHED
  ACTIVE
  PAUSED
  DEPLETED
  EXPIRED
  COMPLETED
}

enum InfluencerVerificationStatus {
  NONE
  PENDING
  VERIFIED
  REJECTED
}

enum ParticipationStatus {
  APPLY_PENDING
  INVITATION_SENT
  ACCEPTED
  REJECTED
}
