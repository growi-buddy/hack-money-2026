datasource db {
  provider = "postgresql"
}

generator client {
  provider   = "prisma-client-js"
  output     = "../prisma/generated"
  engineType = "client"
}

model User {
  id            String  @id @default(cuid())
  walletAddress String  @unique
  name          String?
  email         String? @unique

  campaignsCreated Campaign[]      @relation("UserCampaigns")
  rewardEvents     RewardEvent[]   @relation("UserRewardEvents")
  participations   Participation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Campaign {
  id String @id @default(cuid())

  ownerId String
  owner   User   @relation("UserCampaigns", fields: [ownerId], references: [id])

  title         String
  escrowAddress String
  budgetTotal   Decimal

  rewardEvents CampaignRewardEvent[]

  yellowChannelId String?
  status          CampaignStatus  @default(ACTIVE)
  participations  Participation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RewardEvent {
  id String @id @default(cuid())

  ownerId String
  owner   User   @relation("UserRewardEvents", fields: [ownerId], references: [id])

  name      String
  eventType EventType

  selectors Selector[]
  campaigns CampaignRewardEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CampaignRewardEvent {
  id String @id @default(cuid())

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])

  rewardEventId String
  rewardEvent   RewardEvent @relation(fields: [rewardEventId], references: [id])

  amount     Decimal
  volumeStep Int     @default(1)

  trackedEvents TrackedEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([campaignId, rewardEventId])
}

model Client {
  id        String  @id @default(cuid())
  userAgent String?
  ipAddress String?

  trackedEvents TrackedEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TrackedEvent {
  id String @id @default(cuid())

  campaignRewardEventId String
  campaignRewardEvent   CampaignRewardEvent @relation(fields: [campaignRewardEventId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  data      Json?
  timestamp DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([campaignRewardEventId])
  @@index([clientId])
  @@index([timestamp])
}

model Selector {
  id            String      @id @default(cuid())
  rewardEventId String
  rewardEvent   RewardEvent @relation(fields: [rewardEventId], references: [id])

  selector  String
  eventType SelectorEventType
  isActive  Boolean           @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([rewardEventId, selector])
}

model Participation {
  id           String   @id @default(cuid())
  influencerId String
  influencer   User     @relation(fields: [influencerId], references: [id])
  campaignId   String
  campaign     Campaign @relation(fields: [campaignId], references: [id])

  links          TrackingLink[]
  currentBalance Decimal        @default(0)

  events AnalyticsEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([influencerId, campaignId])
}

model TrackingLink {
  id              String        @id @default(cuid())
  url             String        @unique
  participationId String
  participation   Participation @relation(fields: [participationId], references: [id])

  isActive  Boolean   @default(true)
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AnalyticsEvent {
  id   String    @id @default(cuid())
  type EventType

  participationId String
  participation   Participation @relation(fields: [participationId], references: [id])

  externalTxId    String? @unique
  metadata        Json?
  payoutGenerated Decimal @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum EventType {
  LANDING_PAGE_VIEW
  VIEW_ITEM
  ADD_TO_CART
  CHECKOUT
  PURCHASE_SUCCESS
}

enum SelectorEventType {
  ONCLICK
  HOVER
  DOUBLE_CLICK
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  DEPLETED
  DELETED
}
